<?xml version="1.0" encoding="ISO-8859-1"?>

<project name="Csm" default="all" basedir=".">

  <!-- include ant-contrib -->
  <taskdef resource="net/sf/antcontrib/antlib.xml"/>

  <!-- set properties -->
  <ng.getgeneratorvar name="tresosBase" property="genTresosBase" />
  <ng.getgeneratorvar name="module"     property="genModule"     />
  <ng.getgeneratorvar name="pluginPath" property="genPluginDir"  />
  <ng.getgeneratorvar name="outputDir"  property="genOutputDir"  />
  <ng.getgeneratorvar name="project"    property="genProject"    />
  <ng.getgeneratorvar name="datetime"   property="genDateTime"   />

  <ng.property name="org.partition.paths" xpath="text:join(node:paths(node:refs(node:refs(node:refs(./CsmJobs/CsmJob/*[CsmJobUsePort = 'true']/CsmJobQueueRef)/CsmQueueMainFunctionRef)/CsmMainFunctionPartitionRef)))" />
  <ng.property name="org.rte.enabled.all" xpath="   boolean(num:i(count(as:modconf('Csm')/CsmKeys/CsmKey/*[CsmKeyUsePort = 'true'])))
                                                 or boolean(num:i(count(as:modconf('Csm')/CsmCallbacks/CsmCallback/*[node:empty(./CsmCallbackFunc)])))
                                                 or boolean(num:i(count(node:refs(as:modconf('Csm')/CsmJobs/CsmJob/*[CsmJobUsePort = 'true']/CsmJobPrimitiveRef)/*[@name = 'CsmAEADDecrypt'])))
                                                 or boolean(num:i(count(node:refs(as:modconf('Csm')/CsmJobs/CsmJob/*[CsmJobUsePort = 'true']/CsmJobPrimitiveRef)/*[@name = 'CsmAEADEncrypt'])))
                                                 or boolean(num:i(count(node:refs(as:modconf('Csm')/CsmJobs/CsmJob/*[CsmJobUsePort = 'true']/CsmJobPrimitiveRef)/*[@name = 'CsmDecrypt'])))
                                                 or boolean(num:i(count(node:refs(as:modconf('Csm')/CsmJobs/CsmJob/*[CsmJobUsePort = 'true']/CsmJobPrimitiveRef)/*[@name = 'CsmEncrypt'])))
                                                 or boolean(num:i(count(node:refs(as:modconf('Csm')/CsmJobs/CsmJob/*[CsmJobUsePort = 'true']/CsmJobPrimitiveRef)/*[@name = 'CsmHash'])))
                                                 or boolean(num:i(count(node:refs(as:modconf('Csm')/CsmJobs/CsmJob/*[CsmJobUsePort = 'true']/CsmJobPrimitiveRef)/*[@name = 'CsmMacGenerate'])))
                                                 or boolean(num:i(count(node:refs(as:modconf('Csm')/CsmJobs/CsmJob/*[CsmJobUsePort = 'true']/CsmJobPrimitiveRef)/*[@name = 'CsmMacVerify'])))
                                                 or boolean(num:i(count(node:refs(as:modconf('Csm')/CsmJobs/CsmJob/*[CsmJobUsePort = 'true']/CsmJobPrimitiveRef)/*[@name = 'CsmRandomGenerate'])))
                                                 or boolean(num:i(count(node:refs(as:modconf('Csm')/CsmJobs/CsmJob/*[CsmJobUsePort = 'true']/CsmJobPrimitiveRef)/*[@name = 'CsmSignatureGenerate'])))
                                                 or boolean(num:i(count(node:refs(as:modconf('Csm')/CsmJobs/CsmJob/*[CsmJobUsePort = 'true']/CsmJobPrimitiveRef)/*[@name = 'CsmSignatureVerify'])))" />

  <property environment="env"                                               />
  <property name="genPluginDirGenerateSrc" value="${genPluginDir}/generate" />

  <!-- process -->
  <target name="all" depends="Process.Generate_Src" />

  <target name="Process.Generate_Src">
    <sequential>
      <for list="include,src,make" param="dir">
        <sequential>
          <for param="file">
            <path>
              <fileset dir="${genPluginDirGenerateSrc}/@{dir}/" excludes="*.m" />
            </path>
            <sequential>
              <basename property="org.file.basename" file="@{file}" />
              <echo level="info" message="FILE: @{file} // @{dir}/${org.file.basename}" />
              <if>
                <or>
                  <equals arg1="${org.file.basename}"   arg2="Csm_xPARTITIONx.c" />
                  <equals arg1="${org.file.basename}"   arg2="Csm_xPARTITIONx.h" />
                </or>
                <then>
                  <if>
                    <equals arg1="${org.rte.enabled.all}" arg2="true" />
                    <then>
                      <for param="org.partition.path" list="${org.partition.paths}" delimiter=" ">
                        <sequential>
                          <propertyregex property="org.partition.name" input="@{org.partition.path}" regexp=".*/(\w+)$"   select="\1" />
                          <propertyregex property="new.file.basename"  input="${org.file.basename}"  regexp="xPARTITIONx" replace="${org.partition.name}" global="true" />
                          <ng.tmplgen template="@{file}" file="@{dir}/${new.file.basename}" failonerror="true">
                            <include path="generate" />
                            <variable name="partition.name" value="${org.partition.name}" />
                            <variable name="partition.path" value="@{org.partition.path}" />
                            <variable name="project"        value="${genProject}" />
                          </ng.tmplgen>
                          <var name="org.partition.name" unset="true" />
                          <var name="new.file.basename"  unset="true" />
                          <var name="partition.name"     unset="true" />
                          <var name="partition.path"     unset="true" />
                        </sequential>
                      </for>
                    </then>
                  </if>
                </then>
                <else>
                  <ng.tmplgen template="@{file}" file="@{dir}/${org.file.basename}" failonerror="true">
                    <include path="generate" />
                    <variable name="project" value="${genProject}" />
                  </ng.tmplgen>
                </else>
              </if>
              <var name="org.file.basename" unset="true" />
            </sequential>
          </for>
        </sequential>
      </for>
    </sequential>
  </target>

</project>
